<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KPI Identification</title>

<style>
/* Page Background */
body {
  margin: 0;
  font-family: "Segoe UI", system-ui, sans-serif;
  background: linear-gradient(135deg, #f2efff, #e8e4ff);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 40px;
}

/* Main Container */
.panel {
  background: #ffffff;
  padding: 40px 45px;
  border-radius: 22px;
  max-width: 900px;
  width: 100%;
  box-shadow: 0 20px 45px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Heading */
.panel h1 {
  font-size: 30px;
  font-weight: 800;
  color: #222;
  text-align: center;
  margin: 0;
}

/* Subtitle */
.subtitle {
  text-align: center;
  font-size: 15px;
  color: #666;
  line-height: 1.6;
}

/* Buttons */
.actions {
  text-align: center;
  margin-top: 10px;
}

button {
  padding: 14px 26px;
  font-size: 15px;
  background: #6a5cff;
  color: white;
  border: none;
  cursor: pointer;
  margin: 8px;
  border-radius: 12px;
  font-weight: 700;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* No color change on hover */
button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(106, 92, 255, 0.25);
}

/* Output Panel ‚Äì hidden initially */
#output {
  display: none;
  margin-top: 20px;
  padding: 20px;
  background: #fafafe;
  border-radius: 16px;
  max-height: 500px;
  overflow-y: auto;
  font-size: 14px;
  border: 1px solid #e6e6f5;
}

/* KPI cards */
.kpi-card {
  background: #ffffff;
  border-radius: 14px;
  padding: 16px 18px;
  margin-top: 12px;
  border: 1px solid #e5e7f2;
  box-shadow: 0 6px 16px rgba(0,0,0,0.05);
}

.kpi-card-title {
  font-weight: 700;
  font-size: 15px;
  color: #6a5cff;
  margin-bottom: 6px;
}

.kpi-field {
  font-size: 14px;
  color: #444;
  margin: 4px 0;
}

/* Loading & Error */
.loading {
  text-align: center;
  font-size: 15px;
  color: #555;
  font-weight: 600;
}

.error {
  color: #b71c1c;
  font-weight: 600;
  text-align: center;
}

/* Continue button hidden initially */
#nextBtn {
  display: none;
}
</style>
</head>

<body>

<div class="panel">
  <h1>üìä KPI Identification</h1>
  <div class="subtitle">
    We will analyze your dataset and suggest the most meaningful KPIs for your dashboard.
  </div>

  <div class="actions">
    <button id="runBtn" onclick="runKPI()">Run KPI Identification</button>
    <button id="nextBtn" onclick="goToDashboard()">Continue ‚Üí Dashboard</button>
  </div>

  <!-- Output hidden initially -->
  <div id="output"></div>
</div>

<script>
function runKPI() {
  const output = document.getElementById("output");
  const nextBtn = document.getElementById("nextBtn");
  const runBtn  = document.getElementById("runBtn");

  // Reset UI
  nextBtn.style.display = "none";
  runBtn.disabled = true;
  output.style.display = "block";
  output.innerHTML = "<div class='loading'>‚è≥ Identifying the best KPIs for your dataset‚Ä¶</div>";

  // Read optional user context
  const userContext = JSON.parse(localStorage.getItem("userDatasetContext")) || {};

  const payload = {
    dataset_description: userContext.dataset_description || null,
    dataset_domain: userContext.dataset_domain || null
  };

  fetch("/kpi/identify", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {

    if (data.status === "success" && data.kpi_output) {

      const structuredKPIs = parseKPIText(data.kpi_output);

      if (structuredKPIs.length === 0) {
        output.innerHTML = `
          <div class="error">
            We couldn‚Äôt generate KPIs this time. Please try again.
          </div>
        `;
        runBtn.disabled = false;
        return;
      }

      // Show KPIs
      output.innerHTML = "<h3>Recommended KPIs for Your Dashboard</h3>";
      structuredKPIs.forEach((kpi, index) => {
        output.innerHTML += `
          <div class="kpi-card">
            <div class="kpi-card-title">KPI ${index + 1}: ${kpi.name}</div>
            <div class="kpi-field"><b>Columns Used:</b> ${kpi.columns}</div>
            <div class="kpi-field"><b>Suggested Chart:</b> ${kpi.suggested_chart}</div>
          </div>
        `;
      });

      localStorage.setItem("kpi_result", JSON.stringify(data));
      localStorage.setItem("structured_kpis", JSON.stringify(structuredKPIs));

      runBtn.style.display = "none";
      nextBtn.style.display = "inline-block";
    } 
    else {
      output.innerHTML = `
        <div class="error">
          Something went wrong while generating KPIs. Please try again.
        </div>
      `;
      runBtn.disabled = false;
    }
  })
  .catch(err => {
    console.error(err);
    output.innerHTML = `
      <div class="error">
        Unable to connect to the service. Please check your connection.
      </div>
    `;
    runBtn.disabled = false;
  });
}

// Navigate to dashboard
function goToDashboard() {
  window.location.href = "/dashboard";
}

/**
 * KPI Parser (unchanged functionality)
 */
function parseKPIText(text) {
  text = text
    .replace(/\*\*/g, "")
    .replace(/```/g, "")
    .replace(/- /g, "")
    .trim();

  const kpis = [];
  const blocks = text.split(/KPI\s*\d+:/i).slice(1);

  blocks.forEach(block => {
    let name = "";
    let columns = "";
    let chartType = "";

    const lines = block.split("\n");

    lines.forEach(line => {
      line = line.trim();

      if (line.toLowerCase().startsWith("name:")) {
        name = line.replace(/name:/i, "").trim();
      }
      else if (line.toLowerCase().startsWith("columns:")) {
        columns = line.replace(/columns:/i, "").trim();
      }
      else if (line.toLowerCase().includes("chart type")) {
        chartType = line.replace(/chart type:/i, "").trim();
      }
    });

    if (name && columns && chartType) {
      kpis.push({
        name: name,
        columns: columns,
        suggested_chart: chartType
      });
    }
  });

  return kpis;
}
</script>

</body>
</html>
