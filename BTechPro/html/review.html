<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Data Cleaning Review</title>

  <style>
    /* Page background */
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, sans-serif;
      background: linear-gradient(135deg, #f2efff, #e8e4ff);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }

    /* Main Panel */
    .panel {
      background: #ffffff;
      padding: 40px 45px;
      border-radius: 22px;
      max-width: 1000px;
      width: 100%;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Headings */
    .panel h1 {
      font-size: 30px;
      font-weight: 800;
      color: #222;
      margin: 0;
    }

    .subtitle {
      font-size: 15px;
      color: #666;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    /* Loading */
    .loading {
      text-align: center;
      font-size: 16px;
      color: #555;
      margin: 20px 0;
    }

    /* =====================================================
       ISSUE CARD FORMATTING (REVIEW DESIGN)
    ===================================================== */

    .issue {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 22px;
      border: 1px solid #e5e7f2;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    /* Lift only – no color change */
    .issue:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
    }

    /* Header row */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
    }

    .checkbox-row strong {
      color: #6a5cff;
      font-weight: 700;
    }

    /* Content rows */
    .issue p {
      font-size: 14px;
      color: #444;
      margin: 0;
      line-height: 1.6;
    }

    .issue p b {
      color: #222;
      font-weight: 700;
    }

    /* Explanation box */
    .issue em {
      color: #555;
      font-style: normal;
      background: #f6f7ff;
      padding: 8px 12px;
      border-radius: 8px;
      display: inline-block;
    }

    /* Risk block */
    .risk {
      background: #fff3f3;
      border-left: 4px solid #e53935;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #b71c1c;
    }

    /* Continue Button */
    button {
      margin-top: 25px;
      padding: 14px;
      width: 100%;
      cursor: pointer;
      background: #6a5cff;
      color: #ffffff;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    /* No color change on hover */
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(106, 92, 255, 0.25);
    }
  </style>
</head>

<body>

  <div class="panel">
    <h1>Data Cleaning Review</h1>
    <div class="subtitle">
      Review AI-recommended data quality improvements. Only the checked actions will be applied.
    </div>

    <div id="loading" class="loading">
      ⏳ Generating data quality review using AI...
    </div>

    <div id="issues"></div>

    <button onclick="processSelected()">Apply Selected Changes</button>
  </div>

  <script>
    /* =====================================================
       Call LLM Review API
    ===================================================== */
    async function callLLMReview() {
      const datasetId = localStorage.getItem("dataset_id");
      const sampleRowsRaw = localStorage.getItem("datasetSampleRows");
      const sampleRows = sampleRowsRaw ? JSON.parse(sampleRowsRaw) : null;
      const userContextRaw = localStorage.getItem("userDatasetContext");
      const userContext = userContextRaw ? JSON.parse(userContextRaw) : {};

      if (!datasetId || !sampleRows) {
        alert("Dataset info missing. Please upload again.");
        return;
      }

      /* Fetch metadata */
      const metaRes = await fetch(
        `http://127.0.0.1:8000/cleaning/metadata/${datasetId}`
      );
      if (!metaRes.ok) {
        alert("Failed to fetch metadata.");
        return;
      }

      const datasetMetadata = await metaRes.json();

      const payload = {
        dataset_metadata: datasetMetadata,
        sample_rows: sampleRows,
        user_context: userContext
      };

      /* Call LLM review */
      const res = await fetch(`/llm-agent/llm-review`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        alert("LLM review failed.");
        return;
      }

      return await res.json();
    }

    /* =====================================================
       Render Review
    ===================================================== */
    function renderReview(review) {
      const issuesDiv = document.getElementById("issues");
      document.getElementById("loading").style.display = "none";

      if (!review) {
        issuesDiv.innerHTML = "<p>No review data.</p>";
        return;
      }

      let counter = 0;
      const nextId = () => "chk_" + (++counter);

      review.issues?.forEach(item => {
        const id = nextId();
        issuesDiv.innerHTML += `
          <div class="issue">
            <div class="checkbox-row">
              <input type="checkbox" id="${id}" checked
                data-column="${item.column}"
                data-step="${item.step_id}"
                data-action="${item.recommended_action}"
                data-problem="${item.problem}"
                data-action-reason="${item.action_reason}"
                data-risk="${item.risk_if_ignored}">
              <label for="${id}">
                <strong>${item.column}</strong> → ${item.step_id}
              </label>
            </div>

            <p><b>Problem:</b> ${item.problem}</p>
            <p><b>Recommended Action:</b> ${item.recommended_action}</p>
            <p><em>${item.action_reason}</em></p>

            <div class="risk">
              <b>Risk if ignored:</b> ${item.risk_if_ignored}
            </div>
          </div>
        `;
      });
    }

    /* =====================================================
       Auto-run on load
    ===================================================== */
    (async () => {
      const review = await callLLMReview();
      renderReview(review);
    })();

    /* =====================================================
       Continue Button
    ===================================================== */
    async function processSelected() {
      const datasetId = localStorage.getItem("dataset_id");
      if (!datasetId) {
        alert("Dataset missing.");
        return;
      }

      const selected = [];
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
        selected.push({
          column: cb.dataset.column,
          step_id: cb.dataset.step,
          recommended_action: cb.dataset.action,
          problem: cb.dataset.problem,
          action_reason: cb.dataset.actionReason,
          risk_if_ignored: cb.dataset.risk
        });
      });

      const res = await fetch(`/cleaning/execute-cleaning`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          dataset_id: datasetId,
          actions: selected,
          dry_run: false
        })
      });

      if (!res.ok) {
        alert("Cleaning failed.");
        return;
      }

      alert("✅ Cleaning completed. Moving to KPI analysis...");
      window.location.href = "/kpi";
    }
  </script>

</body>
</html>
