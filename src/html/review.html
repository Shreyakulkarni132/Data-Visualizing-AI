<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Data Cleaning Review</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fa;
      padding: 40px;
    }

    .panel {
      background: white;
      padding: 25px;
      border-radius: 10px;
      max-width: 900px;
      margin: auto;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    h2 {
      margin-bottom: 6px;
    }

    .subtitle {
      color: #555;
      margin-bottom: 20px;
    }

    .issue {
      padding: 15px;
      border-left: 5px solid #1976d2;
      background: #e3f2fd;
      margin-top: 12px;
      border-radius: 6px;
    }

    .checkbox-row {
      margin-bottom: 8px;
    }

    .risk {
      color: #b71c1c;
      margin-top: 8px;
    }

    button {
      margin-top: 30px;
      padding: 14px;
      width: 100%;
      cursor: pointer;
      font-size: 16px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
    }

    button:hover {
      background: #125aa3;
    }

    .loading {
      text-align: center;
      font-size: 18px;
      color: #444;
      margin-top: 20px;
    }
  </style>
</head>

<body>

<div class="panel">
  <h2>üîé Review & Customize Recommended Changes</h2>
  <div class="subtitle">
    Each issue is listed separately. Only checked actions will be applied.
  </div>

  <div id="loading" class="loading">‚è≥ Generating data quality review using AI...</div>
  <div id="issues"></div>

  <button onclick="processSelected()">Continue</button>
</div>

<script>
/* =====================================================
   GLOBAL DEBUG: page load
===================================================== */

/* =====================================================
   Call LLM Review API (with FULL DEBUGGING)
===================================================== */
async function callLLMReview() {

  const datasetId = localStorage.getItem("dataset_id");

  const sampleRowsRaw = localStorage.getItem("datasetSampleRows");

  const sampleRows = sampleRowsRaw ? JSON.parse(sampleRowsRaw) : null;

  const userContextRaw = localStorage.getItem("userDatasetContext");

  const userContext = userContextRaw ? JSON.parse(userContextRaw) : {};

  if (!datasetId) {
    alert("dataset_id missing. Please upload dataset again.");
    return;
  }

  if (!sampleRows) {
    alert("Sample rows missing. Please upload dataset again.");
    return;
  }

  /* -----------------------------
     Call Metadata API
  ----------------------------- */
  const metaUrl = `http://localhost:8001/get-metadata/${datasetId}`;

  const metaRes = await fetch(metaUrl);

  if (!metaRes.ok) {
    console.error("‚ùå Failed to fetch metadata");
    alert("Failed to fetch dataset metadata. Check backend.");
    return;
  }

  const datasetMetadata = await metaRes.json();
  console.log("üìä Metadata received in frontend:", datasetMetadata);

  /* -----------------------------
     Build payload for LLM
  ----------------------------- */
  const payload = {
    dataset_metadata: datasetMetadata,
    sample_rows: sampleRows,
    user_context: userContext
  };


  /* -----------------------------
     Call LLM Review API
  ----------------------------- */
  const llmUrl = "http://localhost:8000/llm-review";

  const res = await fetch(llmUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });


  if (!res.ok) {
    alert("LLM review failed. Check backend logs.");
    return;
  }

  const reviewData = await res.json();
  console.log("üß† LLM Review Result:", reviewData);

  localStorage.setItem("llmReview", JSON.stringify(reviewData));

  return reviewData;
}

/* =====================================================
   Render Review (UI)
===================================================== */
function renderReview(review) {

  const issuesDiv = document.getElementById("issues");
  const loadingDiv = document.getElementById("loading");
  loadingDiv.style.display = "none";

  if (!review) {
    issuesDiv.innerHTML = "<p>‚ö†Ô∏è No review data available.</p>";
    return;
  }

  let counter = 0;
  function nextId() {
    return "chk_" + (++counter);
  }

  /* Column-wise issues */
  if (review.issues && review.issues.length) {

    review.issues.forEach(item => {
      const id = nextId();

      issuesDiv.innerHTML += `
        <div class="issue">
          <div class="checkbox-row">
            <input type="checkbox" id="${id}" checked
              data-column="${item.column}"
              data-step="${item.step_id}"
              data-action="${item.recommended_action}"
              data-problem="${item.problem}"
              data-action-reason="${item.action_reason}"
              data-risk="${item.risk_if_ignored}">
            <label for="${id}">
              <strong>${item.column}</strong>
              ‚Üí ${item.step_id} (${item.recommended_action})
            </label>
          </div>

          <p><b>Problem:</b> ${item.problem}</p>
          <p><b>Recommended action:</b> ${item.recommended_action}</p>
          <p><em>${item.action_reason}</em></p>

          <div class="risk">
            <b>Risk if skipped:</b> ${item.risk_if_ignored}
          </div>
        </div>
      `;
    });
  } else {
    console.warn("‚ö†Ô∏è No column-wise issues found");
  }

  /* Dataset-level steps */
  if (review.dataset_level_steps && review.dataset_level_steps.length) {

    review.dataset_level_steps.forEach(item => {
      const id = nextId();

      issuesDiv.innerHTML += `
        <div class="issue">
          <div class="checkbox-row">
            <input type="checkbox" id="${id}" checked
              data-column="__dataset__"
              data-step="${item.step_id}"
              data-action="${item.recommended_action}"
              data-problem="${item.problem}"
              data-action-reason="${item.action_reason}"
              data-risk="${item.risk_if_ignored}">
            <label for="${id}">
              <strong>${item.step_id}</strong>
              (${item.recommended_action})
            </label>
          </div>

          <p><b>Problem:</b> ${item.problem}</p>
          <p><b>Recommended action:</b> ${item.recommended_action}</p>
          <p><em>${item.action_reason}</em></p>

          <div class="risk">
            <b>Risk if skipped:</b> ${item.risk_if_ignored}
          </div>
        </div>
      `;
    });
  } else {
    console.warn("‚ö†Ô∏è No dataset-level steps found");
  }
}

/* =====================================================
   Auto-run on Page Load
===================================================== */
(async () => {

  localStorage.removeItem("llmReview");  // üî• disable cache during debugging

  let review = await callLLMReview();

  if (!review) {
    try {
      review = await callLLMReview();
    } catch (err) {
      alert("Failed to generate LLM review. Check console.");
      return;
    }
  } else {
    document.getElementById("loading").style.display = "none";
  }

  renderReview(review);
})();

/* =====================================================
   Continue button logic
===================================================== */
async function processSelected() {

  const uploaded = localStorage.getItem("dataset_uploaded");

  if (uploaded !== "true") {
    alert("‚ùå Dataset was not uploaded in this session. Please upload again.");
    window.location.href = "index.html";
    return;
  }

  const datasetId = localStorage.getItem("dataset_id");

  if (!datasetId) {
    alert("‚ùå Dataset not found. Please upload again.");
    return;
  }

  const selected = [];

  document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
    selected.push({
      column: cb.dataset.column,
      step_id: cb.dataset.step,
      recommended_action: cb.dataset.action,
      problem: cb.dataset.problem,
      action_reason: cb.dataset.actionReason,
      risk_if_ignored: cb.dataset.risk
    });
  });


  try {
    const response = await fetch("http://localhost:8001/execute-cleaning", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        dataset_id: datasetId,
        actions: selected,
        dry_run: false
      })
    });


    if (!response.ok) {
      throw new Error("Cleaning request failed");
    }
    alert("‚úÖ Data cleaning completed successfully. Moving to KPI analysis...");
    window.location.href = "kpi_ui.html";

  } catch (err) {
    alert("‚ùå Data cleaning failed. Check backend logs.");
  }
}
</script>

</body>
</html>
